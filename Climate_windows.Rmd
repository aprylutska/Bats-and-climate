---
title: "Climate_windows"
author: "Oleh Prylutskyi"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Data preparation
Setting up a session

```{r, echo=FALSE, message=FALSE}
rm(list = ls()) # reset R's brain
library(tidyverse) # for data manipulations
library(lubridate) # for transforming date variables
library(easyclimate) # for daily climate data extraction
library(sf) # for spatial operations
library(gridExtra) # for ggplot plates
# library(jtools)

# Set custom theme for ggplot2 plots
mytheme <- theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

# Set custom theme as a default for all ggplot below
theme_set(mytheme)

# if LC_TIME=uk_UA.UTF-8, your months will be in Ukrainian.
# To fix that, you need to re-map locate into US (will be back after restart R session)

# Set locale to get English months names
# Sys.setlocale("LC_TIME", "en_US.UTF-8") # for Linux
# Sys.setlocale("LC_TIME", "English") # for Windows

# Custom function to check dependency of selected growth metric on day across years
source("./functions/check_my_var.R")

# Read data and prepare it for further analyses
df <- read.csv("./data/Inventory_all_years_2024-04-04_OP.csv") %>% 
  mutate(date = dmy(Data)) %>% 
  mutate(Year = year(date)) %>% 
  # day of the year (start from the 1st Jan of each year)
  mutate(day = yday(date)) %>% 
  select(-Data) %>% 
  select(-ring) %>% 
  # Drop rows with NAs in W and Ra
  filter(complete.cases(.)) %>% 
  # Drop empty strings (which are not NAs)
  filter(Place != "") %>% 
  filter(Species == "Nyctalus noctula" &
           age == "sad") %>% 
  select(-Species, -age) %>% 
  # Make a new variable with places' unique identifiers
  unite("place_id", Territory:Place, remove = FALSE) %>% 
  mutate(across(c(place_id, Territory, Place, sex, Year),
                as.factor))

```

```{r}
# Loaded packages with their versions
sessionInfo() # to check your locale
```


Since we have nights ("days") with very few bats captured, we decided to drop the nights with less then 10 bats.

```{r}
df <- df %>%  
  # count bats per day
  count(date) %>% 
  # choose days where more than 10 bats
  filter(n > 10) %>% 
  # subset with days where more than 10 bats
  inner_join(df, by = join_by(date)) %>% 
  select(-n)
```


## Exploration of the dynamics of growth metrics 
How Ra related to W?

```{r, message=FALSE, warning=FALSE, echo=FALSE}
ggplot(data = df, aes(Ra, W
                      , colour = Year
                      )
       ) +
  geom_point(alpha = 0.5) + 
  geom_smooth(method = "lm", aes(fill = Year)) +
  # geom_smooth(aes(fill = Year)) + 
  labs(x = "Forearm length, mm",
       y = "Weight, g")
```

Bats with bigger forearm (Ra) have higher mass (W), and vice versa, regardless of year of capture.

Is there any sex differences in growth metrics? Is that possible that male and female bats growth different?

```{r, echo=FALSE}
p1 <- ggplot(data = df, aes(sex, Ra)) +
  geom_violin() + 
  labs(title = "Forearm length",
       y = "Forearm length, mm")

p2 <- ggplot(data = df, aes(sex, W)) +
  geom_violin() + 
  labs(title = "Weight",
       y = "Weight, g")


gridExtra::grid.arrange(p1, p2, nrow=1, ncol=2)
```

Ra might be slightly sex-dependent, Weight does not show such pattern.

Does Ra or W seem to be different among years?

```{r, echo=FALSE}
p1 <- ggplot(data = df, aes(Year, Ra)) +
  geom_violin() + 
  labs(title = "Forearm length",
       y = "Ra, mm")

p2 <- ggplot(data = df, aes(Year, W)) +
  geom_violin() + 
  labs(title = "Weight",
       y = "W, g")

gridExtra::grid.arrange(p1, p2, nrow=1, ncol=2)

rm(p1, p2)
```

In our data set, Ra seems to be constant across the years of survey. Contrary, W tends to vary among years. Therefore, to test our hypothesis about spring weather effect on bat growth, we must apply weight-related metric of growth, not Ra-related.


Does Ra or W changes over the inventory time?

```{r, message=FALSE, warning=FALSE, echo=FALSE}
# t ~ Ra
p_Ra_day_4years <- ggplot(data = df, aes(x = day, y = Ra, colour = Year)) +
  geom_point() +
  geom_smooth(method = "lm", aes(fill = Year)) + 
  labs(title = "Ra ~ DOY",
       x = "Day of the year",
       y = "Forearm length, mm")

# t ~ W
p_W_day_4years <- ggplot(data = df, aes(x = day, y = W, colour = Year)) +
  geom_point() +
  geom_smooth(method = "lm", aes(fill = Year)) +
  labs(title = "W ~ DOY",
       x = "Day of the year",
       y = "Weight, g")


gridExtra::grid.arrange(p_Ra_day_4years, p_W_day_4years, nrow=1, ncol=2)

rm(p_Ra_day_4years, p_W_day_4years)
```



## Check different growth metrics for variation during inventory time
### Ra
fit simple lm 

```{r, warning=FALSE, message=FALSE, echo=FALSE}
check_my_var(df, "Ra", "day")
```

Ra is weakly related to the time of capture. 

### W

```{r, warning=FALSE, message=FALSE, echo=FALSE}
check_my_var(df, "W", "day")
```

W strongly related to the time of capture.

As we can see, Ra remains constant over inventory period, and probably doesn't differ among years (need statistical testing, but gives a hint from the plot). Weight, instead, (i) differs among years, and (ii) grows over the inventory period.

In other words, bats captured later might have higher weight, regardless of spring weather conditions. To minimize an effect of time within inventory period, we calculated series of synthetic growth metrics, and test their variation over the inventory period and between the years.

Check how many bats we captured during the night
```{r, echo=FALSE, message=FALSE}
ggplot(df, aes(day)) +
  geom_histogram() +
  labs(x = "Day of the year",
       y = "Number of bats") +
  facet_wrap(vars(Year))
```
Since weight seems to be growing during inventory timespan, we substituted raw weight (g) by the residuals of body mass-day of the year regression. Body Mass Index (BMI) calculated as residuals from a linear regression of the logarithmically transformed weight (W) against the logarithm of the day-of-the-year (day), for each bat individual.

```{r}
# Fit simple linear model
mod <- lm(log(W) ~ log(day), data = df)

# Get residuals
df$BMI <- residuals(mod)

# Drop unused variables
rm(mod)
```

That way we get scaled from -1 to 1, time independent measure of body condition. Inspired by  [Mikryukov et al. 2023](https://www.science.org/doi/10.1126/sciadv.adj8016), and, partly, Scaled mass index - SMI by [Peig and Green 2009](https://nsojournals.onlinelibrary.wiley.com/doi/abs/10.1111/j.1600-0706.2009.17643.x)


### BMI
```{r, warning=FALSE, message=FALSE}
check_my_var(df, "BMI", "day")
```

BCI is weakly related to the time of caption, as it was expected from the method of calculation.

BCI showed visual differences among years, suggesting bats grow differently depending on year-specific effects.

```{r, echo=FALSE}
ggplot(data = df, aes(Year, BMI)) +
  geom_violin() + 
  labs(y = "Body Mass Index")
```

For Homilsha Forest inventory data, 2014 seems to have insufficient number of nights when 10 or more Noctule bat individuals were captured - possibly we should remove it from further analyses.

```{r, message=FALSE}
ggplot(data = df, aes(day, BMI, colour = Year)) +
  geom_point(alpha = 0.5) + 
  geom_smooth(method = "lm", aes(fill = Year)) + 
  labs(x = "Day of the year",
       y = "Body Mass Index")
  # facet_wrap(vars(sex))
```

Therefore, we choose to test two alternative response variables - forearm length (Ra) and Body Mass Index (BMI), as a possible growth metric in our research.

# Generate weather data

```{r}
# Take a look at the timespan
summary(df$date)
```

```{r eval=FALSE, echo=FALSE, message=FALSE}
# # Create data frame with point coordinates
# coords <- read.csv("./data/coords.csv") %>%
#   # Make a new variable with places' unique identifiers
#   unite("place_id", Territory:place, remove = FALSE) %>%
#   select(-c(Territory, place))
# 
# # Retrieve daily weather values using {easyclimate} package
# # Prcp - Total precipitation in mm
# # Tmin - minimal temperature, Celsius degrees
# # Tmax - maximal temperature, Celsius degrees
# 
# daily <- get_daily_climate(
#   coords = coords,
#   period = 2008:2019,
#   climatic_var = c("Prcp","Tmin","Tmax"),
#   output = "df") %>%
#   mutate(Tmean = (Tmax + Tmin) / 2) %>% 
#   select(-Tmin, -Tmax) %>% 
#   mutate(date = as.Date(date))
# 
# save(daily, file = "./data/daily_weather_2008-2019.Rdata") # save weather data
```

```{r echo=FALSE}
load(file = "./data/daily_weather_2008-2019.Rdata")
daily <- daily %>% 
  mutate(date = as.Date(date))

df <- df %>% 
  rownames_to_column(var = "bat_id")
```


# Make retrospective climate

```{r}

test_df <- df[1:5,]

for (i in 1:nrow(test_df)) {
  
}


# What is the most early date in the dataset?
min(df$day)

lubridate::date()

lubridate::yday(as.Date("2020-07-01"))
```

```{r}
# Timespan in days
time_lag <- 10
# For time series analysis
library(zoo)


tdf <- df %>% 
  count(place_id, date)



# Extract data for one particular event (place_id + date)
daily.one.event <- daily[# Select target place
                        daily$place_id == tdf[1,1] & 
                          # Define starting date
                          daily$date <= tdf[1,2],
                        # Select necessary columns
                        c("date", "Prcp", "Tmean")
                         ]

# Cut date range to respective year
daily.one.event <- daily.one.event %>% 
  # Reorder by decreasing date
  arrange(desc(date)) %>% 
  # Only current year left
  filter(year(date) == max(year(date)))

# Calculate Rolling Mean Temperature
# Create a zoo object with Date as the index
zoo_data <- zoo(daily.one.event$Tmean, order.by = daily.one.event$date)

# Calculate rolling mean with a window of 10 days
rolling_mean <- rollapply(zoo_data, width = time_lag, FUN = mean, align = "right", fill = NA)

# Convert the result back to a data frame
rolling_mean_df <- data.frame(date = index(rolling_mean), Rolling_Mean_Temperature = coredata(rolling_mean))

# Sort the resulting data frame by Date in descending order
rolling_mean_df <- rolling_mean_df[order(rolling_mean_df$date, decreasing = TRUE), ]
# each mean value corresponds to the last day of the 10-day window

# Cut by fixed dates

# July 1st
# Define day of year for the July 1st for the year of event
july_1st <- yday(paste0(year(daily.one.event$date[1]), "-07-01"))

# Define day of year for the July 1st for the year of event
mar_1st <- yday(paste0(year(daily.one.event$date[1]), "-03-01"))

rolling_mean_df <- rolling_mean_df %>% 
  mutate(doy = yday(date)) %>% 
  filter(doy <= july_1st & doy >= mar_1st) %>% 
  select(-doy)

Rolling_Mean_Temperature <- rolling_mean_df[,2]


# Calculate Rolling Summed Precipitation
# Create a zoo object with Date as the index
zoo_data <- zoo(daily.one.event$Prcp, order.by = daily.one.event$date)

# Calculate rolling mean with a window of 10 days
rolling_mean <- rollapply(zoo_data, width = time_lag, FUN = sum, align = "right", fill = NA)

# Convert the result back to a data frame
rolling_mean_df <- data.frame(date = index(rolling_mean), Rolling_Mean_Precipitation = coredata(rolling_mean))

# Sort the resulting data frame by Date in descending order
rolling_mean_df <- rolling_mean_df[order(rolling_mean_df$date, decreasing = TRUE), ]
# each mean value corresponds to the last day of the 10-day window

# Cut by fixed dates
# July 1st
# Define day of year for the July 1st for the year of event
july_1st <- yday(paste0(year(daily.one.event$date[1]), "-07-01"))

# Define day of year for the July 1st for the year of event
mar_1st <- yday(paste0(year(daily.one.event$date[1]), "-03-01"))

rolling_mean_df <- rolling_mean_df %>% 
  mutate(doy = yday(date)) %>% 
  filter(doy <= july_1st & doy >= mar_1st) %>% 
  select(-doy)

Rolling_Mean_Precipitation <- rolling_mean_df[,2]

# Append vectors with rolling temperatures and precipitation
combined_rolling_means <- c(Rolling_Mean_Temperature, Rolling_Mean_Precipitation)






```






