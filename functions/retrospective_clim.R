# Custom fuction to calculate retrospective climate data for sliding window for each event# # Arguments:# event: data frame with place_id and dates, subsequent columns are optional# daily_clim: daily climatic data with place_id and date columns, as well as Tmean and Prcp variable# time_lag: number of days for which climate data to be aggregated# startdayofyear: the earliest date of a time span, in a form of "MM-DD"# enddateofyear: the latest date of a time span, in a form "MM-DD"retrospective_clim <- function(events, daily_clim, time_lag, startdayofyear, enddayofyear) {  # Depends on two other functions: meanslidwin.R and sumslidwin.R    # Calculate sliding means of temperature  sliding_means <- list()    for (i in 1:nrow(events)) {        # Extract data for one particular event (place_id + date)    daily.one.event <- daily_clim[# Select target place                            daily_clim$place_id == events[i,1] &                               # Define starting date                              daily_clim$date <= events[i,2],                            # Select necessary columns                            c("date", "Prcp", "Tmean")                             ]      sliding_means[[i]] <- meanslidwin(data = daily.one.event,                                    datevar = date,                                    xvar = Tmean,                                    time_lag = time_lag,                                    startdateofyear = startdayofyear,                                    enddateofyear = enddayofyear)        sliding_means[[i]] <- as.data.frame.matrix(      t(as.data.frame(sliding_means[[i]]))      )  }    # Bind results for each combination of date and place into a single dataframe  Tmeans_sliding <- bind_rows(sliding_means)    # add prefix 'Tmean_' to all column names  colnames(Tmeans_sliding) <- paste('Tmean', c(1:ncol(Tmeans_sliding)), sep = '_')      # Calculate sliding sums of precipitation  sliding_sums <- list()    for (i in 1:nrow(events)) {        # Extract data for one particular event (place_id + date)    daily.one.event <- daily[# Select target place                            daily_clim$place_id == events[i,1] &                               # Define starting date                              daily_clim$date <= events[i,2],                            # Select necessary columns                            c("date", "Prcp", "Tmean")                             ]      sliding_sums[[i]] <- meanslidwin(data = daily.one.event,                                    datevar = date,                                    xvar = Prcp,                                    time_lag = time_lag,                                    startdateofyear = startdayofyear,                                    enddateofyear = enddayofyear)        sliding_sums[[i]] <- as.data.frame.matrix(      t(as.data.frame(sliding_sums[[i]]))      )  }    # Bind results for each combination of date and place into a single dataframe  Prcp_sliding <- bind_rows(sliding_sums)    # add prefix 'Prcp_' to all column names  colnames(Prcp_sliding) <- paste('Prcp', c(1:ncol(Prcp_sliding)), sep = '_')    # Merge sliding means/sums with bat data  covariates <- events %>%     bind_cols(Tmeans_sliding, Prcp_sliding) %>%     select(-n)    return(covariates)}