---
title: "Climate"
author: "Alona"
date: "2024-01-08"
output: html_document
---
#How weather conditions during pregnancy and lactation influence young bats development?


# Introduction


# Material & Methods
736 subadult bats of 2 species (Nyctalus noctula and Myotis daubentonii) were captured in July in 2008, 2011, 2014 and 2019 in the frame of bat monitoring in the National Nature Park “Homilshansky lisy”, Kharkiv Oblast, Ukraine. Bats were caught with nylon mist nets 12 m in length and 3 m high; mesh size-15 mm) at exactly the same location each year.Totally 18 capture nights every year. Mist nets were open from sunset until sunrise, weather permitting. Body weight (0.1 g) and forearm lenght (0.1 mm) measurements were done in 8-10 hours after the end of capture.
We recorded species, sex and age of the bat. The main features in identifying bat age were: ossification degree of joints of finger phalanx of the wing (the presence of cartilage at sight check), size and shape of nipples for females. We took into consideration the degree of grind of the canine teeth for Nyctalus noctula. 
All animals after biometrical process were released as soon as possible. All measures related to bat capturing, holding and carrying in bags were ethical, respectful for animal welfare and conservation of protected species, according to Gannon (2007).


Research question and predictions
Does temperature (and rainfall) during period of pregnancy and lactation affect growth of young bats?Warmer and drier conditions lead to bigger sizes2 species, migrant and sedentary


## Підготовка даних про довжину передпліччя Ra та вагу W кажанів


```{r, echo=FALSE, message=FALSE}
rm(list = ls()) # reset R's brain
library(lubridate)  
library(ggplot2)
library(tidyverse) # for data manipulations
library(easyclimate) # for daily climate data extraction
library(sf) # for spatial operations
library(jtools)

# Loaded packages with their versions
sessionInfo() # to check your locale

# if LC_TIME=uk_UA.UTF-8, your months will be in Ukrainian.
# To fix that, you need to re-map locate into US (will be back after restart R session)

# Set locale to get English months names
# Sys.setlocale("LC_TIME", "en_US.UTF-8") # for Linux
# Sys.setlocale("LC_TIME", "English") # for Windows

```

```{r}
df <- read.csv("Homolsha_all_years.csv") # read data from *.csv file

# Set variables classes
df$date <- as.Date(df$Data, "%d.%m.%Y") # convert date to R Data format
df$Place <- as.factor(df$Place)
df$Species <- as.factor(df$Species)
df$sex <- as.factor(df$sex)
df$age <- as.factor(df$age)

df$Year <- year(df$date) #виокремлення року
df$Year <-as.factor (df$Year)
#створення нової колонки з даними про день від початку року 
df$day <- yday(df$date)


df$Ra <- sub(",", ".", df$Ra) #заміна ком на крапки в промірах передпліччя
df$W <- sub(",", ".", df$W)

df$Ra <-as.numeric (df$Ra) #присвоєння промірам нумеричного типу даних
df$W <-as.numeric (df$W)

# Delete unused variables
df$Data <- NULL
df$reproductive.status <- NULL

# Take a look at the data
summary(df)

```


Check age structure among species
```{r}
table (df$Species,df$age)
```


Відбираємо лише два види та тільки молодих - вечірниці та нічниці
```{r}
# Subset only some species (e.g., N.noc. and M.daubentonii )
df <- subset(df,
              Species %in% c('Nyctalus noctula',
                             'Myotis daubentonii') &
                age == "sad"
              )

summary (df)
```



## Make synthetic growth indices

```{r}
# Ra/W
df$Ra_W <- df$Ra / df$W

# Ra / square root of W
df$Ra_sqW <- df$Ra / sqrt(df$W)

# Ra / log W
df$Ra_logW <- df$Ra / log(df$W)

# Ra / square root of day-of-year
df$RA_sqDOY <- df$Ra / sqrt(df$day)

# Since day of year is not changing hugely during sampling time span in absolute 
# measure, scaling to July, 1st = "zero day" may be a possible alternative

# Ra / square root of day-since-Jul1
# Which day-of-year is July, 1st
Jul_1st <- tibble(
  year = c(2008, 2011, 2014, 2019),
  Jul1_DOY = c(lubridate::yday(as.Date("2008-07-01")),
               lubridate::yday(as.Date("2011-07-01")),
               lubridate::yday(as.Date("2014-07-01")),
               lubridate::yday(as.Date("2019-07-01"))
  )
)

Jul_1st
```

```{r}
# Only 2008 as a leap year, so we can calculate ration with zero-day using
# the following loop:

for(i in 1: nrow(df)){
    if(df$Year[i] == "2008"){
    df$RA_sqDsJ1[i] <- df$Ra[i] / sqrt(df$day[i] - 183)
    } else {
      df$RA_sqDsJ1[i] <- df$Ra[i] / sqrt(df$day[i] - 182)
    }
}

```








```{r}
ggplot(data = df, aes(Ra, W, colour = Species)) +
  geom_point()
```

## t ~ Ra

```{r}
ggplot(data = df, aes(x = day, y = Ra, colour = Year)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_wrap(vars(Species),
             scales = "free") 
```

## t ~ W

```{r}
ggplot(data = df, aes(x = day, y = W, colour = Year)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_wrap(vars(Species),
             scales = "free") 
```

```{r}
table(df$Year, df$Species)
```

```{r}
# Subset only some species (e.g., N.noc.)
nnoc_df <- subset(df, 
              Species %in% c('Nyctalus noctula') & 
                age == "sad"
              )

summary (nnoc_df)
```

## Перевірка чи дані впродовж двох тижнів різняться
Instructions from https://tobiasroth.github.io/BDAEcology/lmer.html
Additional beginner's guide https://rstudio-pubs-static.s3.amazonaws.com/63556_e35cc7e2dfb54a5bb551f3fa4b3ec4ae.html

```{r, message=FALSE}
library (lme4)
# `lme4` requires `Matrix` >= 1.6-4. See for more details https://community.rstudio.com/t/error-in-initializeptr-function-cholmod-factor-ldeta-not-provided-by-package-matrix/178694
```


Null-model (random effect only)
```{r}
mod0Ra <- lmer (Ra ~ 1 + (1|Year),
             data=nnoc_df
             # REML=F # https://tobiasroth.github.io/BDAEcology/lmer.html#restricted-maximum-likelihood-estimation-reml
             )

summary (mod0Ra)
```


```{r}
summ(mod0Ra)
```

To test the variance of intersepts
```{r}
library(lmerTest)
ranova(mod0Ra)
```

Model with one fixed effect - time (as day from the beginning of year)
```{r}
mod1Ra <- lmer (Ra ~ day + (1 |Year),
             data=nnoc_df
             # REML=F # https://tobiasroth.github.io/BDAEcology/lmer.html#restricted-maximum-likelihood-estimation-reml
             )

summary (mod1Ra)
```


```{r}
library(jtools)
summ(mod1Ra)
```

Tp test the variance of intersepts
```{r}
library(lmerTest)
ranova(mod1Ra)
```

```{r}
plot (mod1Ra)
```

## t ~ W
Make a model with Weight gata of subadult bast 
Null-model (random effect only)

```{r}
mod0_W <- lmer (W ~ 1 + (1|Year),
             data=nnoc_df
             # REML=F # https://tobiasroth.github.io/BDAEcology/lmer.html#restricted-maximum-likelihood-estimation-reml
             )


summ(mod0_W)
```

Model weight with one fixed effect - time (as day from the beginning of year)
```{r}
mod1W <- lmer (W ~ day + (1 |Year),
             data=nnoc_df
             # REML=F # https://tobiasroth.github.io/BDAEcology/lmer.html#restricted-maximum-likelihood-estimation-reml
             )

summ(mod1W)
```

```{r}
library(lmerTest)
ranova(mod1W)
```

```{r}
plot (mod1W)
```

```{r}
ggplot(data = df, aes(x = day, y = W, colour = Year)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_wrap(vars(Species),
             scales = "free") 
```

## Model for body condition Ra-W
створення нової колонки з даними про співідношення Ra до W
```{r}
nnoc_df$Ra_W <- nnoc_df$Ra / nnoc_df$W
nnoc_df$Ra_sqrtW <- nnoc_df$Ra / sqrt (nnoc_df$W)
nnoc_df$Ra_logW <- nnoc_df$Ra / log (nnoc_df$W)
nnoc_df$Ra_sqrtday <- nnoc_df$Ra / sqrt (nnoc_df$day)
nnoc_df$Ra_logday <- nnoc_df$Ra / log (nnoc_df$day)
```









## Generate weather data
```{r}
# Take a look at the timespan
summary(df$date)
```



```{r eval=FALSE, echo=FALSE, message=FALSE}
# # Create data frame with point coordinates
# coords <- data.frame(
#   place = c("R1", "R2", "Fed1", "Fed2", "Fed3", "F1", "F2", "F3", "F4"),
#   lon = c(36.33329, 36.32946, 36.32732, 36.32863, 36.33436, 36.32396, 36.32319, 36.31990, 36.31909),
#   lat = c(49.62554, 49.62092, 49.62298, 49.61411, 49.60477, 49.61782, 49.61169, 49.60948, 49.60782)
# )
# 
# # Retrieve daily weather values using {easyclimate} package
# # Prcp - Total precipitation in mm
# # Tmin - minimal temperature, Celsius degrees
# # Tmax - maximal temperature, Celsius degrees
# 
# daily <- get_daily_climate(
#   coords = coords,
#   period = 2008:2019,
#   climatic_var = c("Prcp","Tmin","Tmax"),
#   output = "df")
# 
# save(daily, file = "daily_weather_2008-2019.Rdata") # save weather data
```

```{r echo=FALSE}
load(file = "daily_weather_2008-2019.Rdata")
```


### Calculate additional weather variables
Calculate derived metrics (diurnial range, mean daily temperature, positive daily temperature).
Subset only years of inventory (2008, 2011, 2014, 2019)
```{r}
daily <- daily %>% 
   # Calculate derived metrics for each day
  mutate(DiurnialRange = Tmax - Tmin,
         MeanTemp = (Tmin + Tmax) / 2,
         # Get only positive mean temperatures (for Growing degree units calculation)
         PositiveMeanTemp = ifelse(MeanTemp > 0, MeanTemp, 0)) %>%
  # Adjust dates and add new variables for month and years
  mutate(date = as.Date(date),
         month = months(date),
         year = format(date, format = "%Y")) %>%
  # Filter only years of inventories
  filter(year %in% c(2008, 2011, 2014, 2019))
```

### Calculate GDU
Growing degree units (Sum of the mean daily temperature above 0 from the start of the year).
Create custom function that calculate GDUs for each day of the year.
```{r}
# Must be calculated for each year separately.
# Data must contain one row per day and the variable with the positive daily mean temperature.
# If mean temperature is negative, put zero in this variable.
# Also the variable with the full date MUST be character AND named "date"
gdu <- function(daily_data_for_one_year, 
                var_with_PositiveMeanTemp) {
  GDU <- list() # prepare empty list
  
  # looping through the daily data within the year 
  for (i in 1:nrow(daily_data_for_one_year)) {
    GDU[[i]] <- c(daily_data_for_one_year$date[i],
                  sum(daily_data_for_one_year[1:i, var_with_PositiveMeanTemp])
    )
  }
  # reshape obtained list
  GDU <- as.data.frame(GDU)
  GDU <- as.data.frame(t(GDU))
  colnames(GDU) <- c("date", "GDU")
  # retrieve the result
  return(GDU)
}
```

Calculate GDU and add it to the main weather data frame.
```{r}
# List all required years
list_of_years <- c(2008, 2011, 2014, 2019)

# Create an empty list
gdu_by_years <- list()

for (k in 1:length(list_of_years)) {
  # Calculate GDUs for each year
  df_temp <- daily %>% 
    # loop doesn't seem to work with `date` format, convert to character
    mutate(date = as.character(date)) %>%
    filter(year == list_of_years[[k]]) %>% 
    select(place, date, PositiveMeanTemp) %>%
    split(.$place)
  
  # Create an empty list
  df_gdu <- list()
  
  # Loop through the list elements (data frames with all days for the particular year,
  # split by place ID)
  for (i in 1:length(df_temp)) {
    df_gdu[[i]] <- gdu(df_temp[[i]], "PositiveMeanTemp")
    df_gdu[[i]]$place <- df_temp[[i]]$place
  }
  
  # Transform list of data frames into a single data frame
  gdu_by_years[[k]] <- bind_rows(df_gdu)

}

# Transform list of data frames into a single data frame
GDU <- bind_rows(gdu_by_years) %>% 
  mutate(date = as.Date(date))

# Add GDU as additional variable to the daily climate data for required years
daily <- daily %>% 
  left_join(GDU, by = c("date", "place"))

# Drop temporary variables not longer required
rm(df_temp, df_gdu, GDU, gdu_by_years, i, k)
```



## Explore weather data
We selected two periods that are supposed to be influential for bar growth: the *spring* (March 25 - May 24) as a pre-natal period for bat cups, and the *summer* (May 25 - Jut 24) as an early post-natal period prior to the inventory.

Since 2008 was a leap year, Julian days was different.
What is March 25 for each year?
```{r}
daily %>% 
  mutate(day = lubridate::yday(date)) %>% 
  select(date, day) %>% 
  filter(month(date) == 3 & day(date) == 25) %>% 
  unique()
```


Excluding dates out of those two periods
```{r}
# Pre-natal (spring) periods only
daily %>% 
  filter(date >= "2008-03-25" & date < "2008-05-25") %>% 
  mutate(season = "spring") -> spring2008

daily %>% 
  filter(date >= "2011-03-25" & date < "2011-05-25") %>% 
  mutate(season = "spring") -> spring2011

daily %>% 
  filter(date >= "2014-03-25" & date < "2014-05-25") %>% 
  mutate(season = "spring") -> spring2014

daily %>% 
  filter(date >= "2019-03-25" & date < "2019-05-25") %>% 
  mutate(season = "spring") -> spring2019

# Post-natal (summer) periods only
daily %>% 
  filter(date >= "2008-05-25" & date < "2008-06-25") %>% 
  mutate(season = "summer") -> summer2008

daily %>% 
  filter(date >= "2011-05-25" & date < "2011-06-25") %>% 
  mutate(season = "summer") -> summer2011

daily %>% 
  filter(date >= "2014-05-25" & date < "2014-06-25") %>% 
  mutate(season = "summer") -> summer2014

daily %>% 
  filter(date >= "2019-05-25" & date < "2019-06-25") %>% 
  mutate(season = "summer") -> summer2019

daily_spring_summer <- bind_rows(spring2008, spring2011, spring2014, spring2019,
                                 summer2008, summer2011, summer2014, summer2019)

# Remove unused temorary variables
rm(spring2008, spring2011, spring2014, spring2019,
   summer2008, summer2011, summer2014, summer2019)
```



Take a look at the minimal temperatures for springs in 2008-2019
```{r}
daily_spring_summer %>% 
  filter(season == "spring") %>% 
  select(date, year, Tmin) |>
  ggplot(aes(Tmin)) +
  geom_density(fill = "lightgreen", 
               alpha = 0.5) +
  facet_wrap( ~ factor(year)) +
  labs(title = "Spring",
       x = "Minimal temperature") +
  theme_bw()

ggsave("./figures/Tmin_2008-2019_density_Spring.png", width = 16, height = 12, units = "cm", dpi = 150)
```

Take a look at the minimal temperatures for summers in 2008-2019
```{r}
daily_spring_summer |>
  filter(season == "summer") %>% 
  select(date, year, Tmin) |>
  ggplot(aes(Tmin)) +
  geom_density(fill = "lightgreen", 
               alpha = 0.5) +
  facet_wrap( ~ factor(year)) +
  labs(title = "Summer",
       x = "Minimal temperature") +
  theme_bw()

ggsave("./figures/Tmin_2008-2019_density_Apr.png", width = 16, height = 12, units = "cm", dpi = 150)
```



## Generate exploratory variables for bat growth ~ weather models

```{r}
# Cumulative precipitation
daily_spring_summer %>% 
  group_by(season, place, year) %>% 
  summarise(sum(Prcp)) %>% 
  rename(Prcp = 4) %>% 
  as_tibble() -> Prcp_var

# Split spring only precipitation
Prcp_var %>% 
  filter(season == "spring") %>% 
  rename(Prcp_spr = Prcp) %>% 
  select(-season) -> Prcp_spring

# Split summer only precipitation
Prcp_var %>% 
  filter(season == "summer") %>% 
  rename(Prcp_summ = Prcp) %>% 
  select(-season) -> Prcp_summer


# Average minimum daily temperature
daily_spring_summer %>% 
  group_by(season, place, year) %>% 
  summarise(mean(Tmin)) %>% 
  rename(Tmin = 4) %>% 
  as_tibble() -> Tmin_var

# Dissect only spring minimal temperatures
Tmin_var %>% 
  filter(season == "spring") %>% 
  rename(Tmin_spr = Tmin) %>% 
  select(-season) -> Tmin_spring

# Dissect only spring minimal temperatures
Tmin_var %>% 
  filter(season == "summer") %>% 
  rename(Tmin_summ = Tmin) %>% 
  select(-season) -> Tmin_summer

# Number of days with mean temperature less or equal 10 Celsius degree
daily_spring_summer %>% 
  filter(season == "spring") %>% 
  filter(MeanTemp <= 10) %>% 
  count(season, place, year) %>% 
  as_tibble() %>% 
  rename(Less10_var = n) %>% 
  select(-season) -> Less10_var


# GDU at the end of a spring period
daily_spring_summer %>% 
  filter(month(date) == 5 & day(date) == 24) %>% 
  select(place, year, GDU) %>% 
  rename(GDU_spr = GDU) -> GDU_spring

# GDU at the end of a summer period
daily_spring_summer %>% 
  filter(month(date) == 6 & day(date) == 24) %>% 
  select(place, year, GDU) %>% 
  rename(GDU_summ = GDU) -> GDU_summer

# Merge weather covariates
Prcp_spring %>% 
  left_join(Prcp_summer) %>% 
  left_join(Tmin_spring) %>% 
  left_join(Tmin_summer) %>% 
  left_join(Less10_var) %>% 
  left_join(GDU_spring) %>% 
  left_join(GDU_summer) %>% 
  rename(Place = place,
         Year = year) -> covariates

# Drop unused variables
rm(Prcp_spring, Prcp_var, Prcp_summer, Tmin_spring, Tmin_summer, Tmin_var, 
   GDU_summer, GDU_spring, Less10_var, daily_spring_summer)

```






Merge weather data with bat survey data and save it for further sessions
```{r}
# Merge data
df_clim <- df %>% 
  left_join(covariates)

# Export climate data for further sessions
save(df_clim, file = "bats_wClimate_2008-2019.Rdata")
```