---
title: "climwin"
author: "Oleh Prylutskyi"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list = ls()) # reset R's brain
```

# Data preparation
Setting up a session

```{r Package installation, echo=FALSE, eval=FALSE, message=FALSE}
# Define the list of required libraries
required_packages <- c(
  "tidyverse",   # for data manipulations
  "lubridate",   # for transforming date variables
  "easyclimate", # for daily climate data extraction
  "sf",          # for spatial operations
  "gridExtra",   # for ggplot plates
  "grid",        # required for gridExtra
  "climwin",     # for modelling climatic windows
  "lme4"         # for fiting mixed-effect models
)

# Function to check and install missing libraries
check_and_install <- function(packages) {
  for (pkg in packages) {
    if (!requireNamespace(pkg, quietly = TRUE)) {
      message(paste("Installing missing package:", pkg))
      install.packages(pkg)
    }
    library(pkg, character.only = TRUE)
  }
}

# Run the function for required libraries
check_and_install(required_packages)

# Additional libraries (commented out)
# library(AICcmodavg) # to compare models by AIC
# library(performance)
# library(jtools)
```

```{r, echo=FALSE, message=FALSE}
rm(list = ls()) # reset R's brain

# Set custom theme for ggplot2 plots
mytheme <- theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

# Set custom theme as a default for all ggplot below
theme_set(mytheme)

# Set model and figure directories
modeldir <- "./models_200rep_13w_absW_nnoc/"
figuredir <- "./figures_200rep_13w_absW_nnoc/"

# Lower threshold for the number of bats captured at a night
threshold <- 1

# if LC_TIME=uk_UA.UTF-8, your months will be in Ukrainian.
# To fix that, you need to re-map locate into US (will be back after restart R session)

# Set locale to get English months names
# Sys.setlocale("LC_TIME", "en_US.UTF-8") # for Linux
# Sys.setlocale("LC_TIME", "English") # for Windows

# Custom function to check dependency of selected growth metric on day across years
source("./functions/check_my_var.R")

# Read data and prepare it for further analyses
df <- read.csv("./data/Inventory_all_years_2024-04-04_OP.csv") %>% 
  mutate(date = dmy(Data)) %>% 
  mutate(Year = year(date)) %>% 
  # day of the year (start from the 1st Jan of each year)
  mutate(day = yday(date)) %>% 
  select(-Data) %>% 
  select(-ring) %>% 
  # Drop rows with NAs in W and Ra
  filter(complete.cases(.)) %>% 
  # Drop empty strings (which are not NAs)
  filter(Place != "") %>% 
  filter(Species == "Nyctalus noctula" &
           age == "sad") %>% 
  select(-Species, -age) %>% 
  # Make a new variable with places' unique identifiers
  unite("place_id", Territory:Place, remove = FALSE) %>% 
  mutate(across(c(place_id, Territory, Place, sex, Year),
                as.factor))

```

```{r}
# Loaded packages with their versions
sessionInfo() # to check your locale
```

Since we have nights ("days") with very few bats captured, we decided to drop the nights with lesser bats captured than in the threshold.

```{r, echo=FALSE, message=FALSE}
df <- df %>%
  # count bats per day
  count(date) %>%
  # choose days where more than 10 bats
  filter(n >= threshold) %>%
  # subset with days where more than 10 bats
  inner_join(df, by = join_by(date)) %>%
  filter(Territory != "Smolensk" &
           Territory != "Bryansk") %>%
  filter(Territory != "Chornobyl") %>%
  # filter(Territory == "Homilsha") %>% 
  select(-n)
```

# Exploratory analysis
Check how many bats were captured during the night, per territory.
```{r, echo=FALSE, message=FALSE}
ggplot(df, aes(x = day, fill = Territory)) +
  geom_histogram() +
  labs(x = "Day of the year",
       y = "Number of bats") +
  facet_wrap(vars(Year))
```

## Growth metrics distribution
For each bat captured, we measured two growth-related numerical variables - forearm length (Ra, mm), and weight (W, g).

What the statistical distribution of response variables?
```{r, echo=FALSE}
# Ra
p_dist_Ra <- ggplot(df, aes(x = Ra)) +
  geom_density(fill = "blue", alpha = .5) +
  labs(title = "Shapiro-Wilk normality test",
       subtitle = paste0("W = ", round(shapiro.test(df$Ra)$statistic, 
                                       digits = 2), 
                         ", p-value = ", round(shapiro.test(df$Ra)$p.value, 
                                               digits = 4)
                         )
       )

# W
p_dist_W <- ggplot(df, aes(x = W)) +
  geom_density(fill = "red", alpha = .5) +
  labs(title = "Shapiro-Wilk normality test",
     subtitle = paste0("W = ", round(shapiro.test(df$W)$statistic, 
                                     digits = 2), 
                       ", p-value = ", round(shapiro.test(df$W)$p.value, 
                                             digits = 4)
                       )
     )

gridExtra::grid.arrange(p_dist_Ra, p_dist_W, nrow=1, ncol=2)
rm(p_dist_W, p_dist_Ra)
```
Distribution in both response variables deviates from normality.

How Ra related to W?
```{r, message=FALSE, warning=FALSE, echo=FALSE}
ggplot(data = df, aes(Ra, W, colour = Year)) +
  geom_point(alpha = 0.5) + 
  geom_smooth(method = "lm", aes(fill = Year)) +
  # geom_smooth(aes(fill = Year)) + 
  labs(x = "Forearm length (mm)",
       y = "Weight (g)")
```

Bats with bigger forearm values (Ra) have higher mass (W), and vice versa. At the same time, there are visible differences among years.

## Sex dependency
Is there any sex differences in growth metrics? Is that possible that male and female bats growth different?
```{r, echo=FALSE}
# Ra
shapiro.test(df$Ra)

ggplot(df, aes(x = Ra, colour = sex)) +
  geom_density(aes(fill = sex), alpha = .5)

# Bartlett test of homogeneity of variances
bartlett.test(Ra ~ sex, df)
# If p > 0.05, accept Null Hypothesis (variance are homogeneous)

# Student's t-test. Test significance of differences in sepal.length between two iris species
Ra_t <- t.test(Ra ~ sex, df)
# p-value << 0.05 - reject Null Hypothesis

# Mann-Whitney (Wilcoxon) test
Ra_wilk <- wilcox.test(Ra ~ sex, data = df)

# W
shapiro.test(df$W)

ggplot(df, aes(x = W, colour = sex)) +
  geom_density(aes(fill = sex), alpha = .5)

# Bartlett test of homogeneity of variances
bartlett.test(W ~ sex, df)
# If p > 0.05, accept Null Hypothesis (variance are homogeneous)

# Student's t-test. Test significance of differences in sepal.length between two iris species
W_t <- t.test(W ~ sex, df)
# p-value << 0.05 - reject Null Hypothesis

# Mann-Whitney (Wilcoxon) test
W_wilk <- wilcox.test(W ~ sex, data = df)
```
To select a method for assessing sex dependent variance, we first checked homogeneity of variances and normality. Bartlett test indicated good homogeneity for both Ra and W, but Shapiro-Wilk test indicated deviation from normality. On the other hand, visual exploration suggest highly symmetrical distribution. Thus, we tested differences between male and female bats using t-test:

```{r, echo=FALSE}
p1 <- ggplot(data = df, aes(sex, Ra)) +
  geom_violin(aes(colour = sex)) + 
  geom_boxplot(aes(fill = sex, colour = sex), alpha = 0.3, outliers = T) +
  labs(title = "Forearm length",
       # # Wilcoxon rank sum test with continuity correction
       # subtitle = paste0("W = ",  round(Ra_wilk$statistic, digits = 3), 
       #                   " p = ", round(Ra_wilk$p.value, digits = 3)),
       # Welch Two Sample t-test
       subtitle = paste0("t = ",  round(Ra_t$statistic, digits = 3), 
                         " p = ", round(Ra_t$p.value, digits = 3)),
       x = "",
       y = "Forearm length (mm)",
       caption = paste0("n(f) = ", nrow(df[df$sex == "female",]),
                        ", n(m) = ", nrow(df[df$sex == "male",])
                        )
       )

p2 <- ggplot(data = df, aes(sex, W)) +
  geom_violin(aes(colour = sex)) + 
  geom_boxplot(aes(fill = sex, colour = sex), alpha = 0.3, outliers = T) +
  labs(title = "Weight",
       # # Wilcoxon rank sum test with continuity correction
       # subtitle = paste0("W = ",  round(W_wilk$statistic, digits = 3), 
       #                   " p = ", round(W_wilk$p.value, digits = 3)),
       # Welch Two Sample t-test
       subtitle = paste0("t = ",  round(W_t$statistic, digits = 4), 
                         " p = ", round(W_t$p.value, digits = 4)),
       x = "",
       y = "Weight (g)",
       caption = paste0("n(f) = ", nrow(df[df$sex == "female",]),
                        ", n(m) = ", nrow(df[df$sex == "male",])
                        )
       )


gridExtra::grid.arrange(p1, p2, nrow=1, ncol=2)

rm(Ra_t, Ra_wilk, W_t, W_wilk)
```

Forearm length appeared to be sex-dependent, Weight did not show such pattern.

To reveal possible interactions with sex, we then took a look at the sex-dependent variation of Ra/W across the years of sampling.

```{r, echo=FALSE, warning=FALSE}
p1 <- ggplot(data = df, aes(x = Year, y = Ra)) +
  geom_violin(aes(colour = sex)) + 
  geom_boxplot(aes(fill = sex, colour = sex), alpha = 0.3, outliers = F) +
  geom_point(aes(colour = sex), alpha = 0.5) +
  labs(title = "a) Forearm length",
       y = "Forearm length (mm)",
       fill = NULL,
       colour = NULL) +
  theme(legend.position = c(.2, .1))

p2 <- ggplot(data = df, aes(x = Year, y = W)) +
  geom_violin(aes(colour = sex)) + 
  geom_boxplot(aes(fill = sex, colour = sex), alpha = 0.3, outliers = F) +
  geom_point(aes(colour = sex), alpha = 0.5) +
  labs(title = "b) Weight",
       y = "Weight (g)",
       fill = NULL,
       colour = NULL) +
  theme(legend.position = c(.2, .1))

gridExtra::grid.arrange(p1, p2, nrow=1, ncol=2)

rm(p1, p2)
```

In our data set, male/female ratio in Ra seemed to be constant across the years of survey - young male bats had always smaller arm than female ones. Contrary, W did not show a constant pattern across the year.

Therefore, to test our hypothesis about spring weather effect on bat growth, we must fit models that include sex as either nominative explanatory variables with interactions or random effect.

## Changes over the inventory time
Bat survey (inventory) lasted approximately two weeks in July, after all of the juveniles turn to be able to fly. Therefore, we can expect some directed changes in bat body measures over this period. We tested the relations between growth metrics (Ra and W) and day-of-the-year, controlling different years.

```{r, message=FALSE, warning=FALSE, echo=FALSE}
# t ~ Ra
p_Ra_day_4years <- ggplot(data = df, aes(x = day, y = Ra, colour = Year)) +
  geom_point(shape = 1, alpha = 0.8) +
  geom_smooth(method = "lm", aes(fill = Year), linewidth = .5) + 
  labs(title = "Ra ~ DOY",
       x = "Day of the year",
       y = "Forearm length (mm)",
       fill = NULL,
       colour = NULL) +
  theme(legend.position = "bottom")

# t ~ W
p_W_day_4years <- ggplot(data = df, aes(x = day, y = W, colour = Year)) +
  geom_point(shape = 1, alpha = 0.8) +
  geom_smooth(method = "lm", aes(fill = Year), linewidth = .5) +
  labs(title = "W ~ DOY",
       x = "Day of the year",
       y = "Weight (g)",
       fill = NULL,
       colour = NULL) +
  theme(legend.position = "bottom")


gridExtra::grid.arrange(p_Ra_day_4years, p_W_day_4years, nrow=1, ncol=2)

rm(p_Ra_day_4years, p_W_day_4years)
```

Ra did not seem to change over the survey period, whereas W constantly increased. If we compare study years, slopes of simple linear models slightly varies, as well as intercepts, but remains close to the horizontal (Ra seemed to vary independently on either year or capture date). By contrast, W shows constant slopes over the years, but differs in intercepts. In other words, 

- Ra does changes over a single survey period,
- W steadily increased,
- there are quantitative differences in average bat W across the years, but not in the way W is changed over the survey period.

We also check if some sex-dependent differences in W exist in each year.

```{r, echo=FALSE, message=FALSE}
# t ~ Ra
p_Ra_doi <- ggplot(data = df, aes(x = day, y = Ra, colour = sex)) +
  geom_point(shape = 1, alpha = 0.8) +
  geom_smooth(method = "lm", aes(fill = sex), linewidth = .5) + 
  labs(title = "a) Ra ~ DOY",
       x = "Day of the year",
       y = "Forearm length (mm)") +
  facet_wrap(vars(Year), scales = "fixed", ncol = 2) +
  theme(legend.position = "bottom")

# t ~ W
p_W_doi <- ggplot(data = df, aes(x = day, y = W, colour = sex)) +
  geom_point(shape = 1, alpha = 0.8) +
  geom_smooth(method = "lm", aes(fill = sex), linewidth = .5) + 
  labs(title = "b) W ~ DOY",
       x = "Day of the year",
       y = "Weight (g)") +
  facet_wrap(vars(Year), scales = "fixed", ncol = 2) +
  theme(legend.position = "bottom")

gridExtra::grid.arrange(p_Ra_doi, p_W_doi, nrow=1, ncol=2)
rm(p_Ra_doi, p_W_doi)
```

To numerically check different growth metrics' variation during inventory time, we fit a simple linear models per years. 

```{r, warning=FALSE, message=FALSE, echo=FALSE}
check_my_var(df, "Ra", "day", years = "Year")
```

Ra is weakly related with the time of capture. 

```{r, warning=FALSE, message=FALSE, echo=FALSE}
check_my_var(df, "W", "day", "Year")
```

W strongly related with the time of capture.

As we can see, Ra generally remains constant over survey period, and probably doesn't differ among years. Weight, instead, (i) differs among years, and (ii) grows over the survey period.

In other words, bats captured later in a year might have higher weight, regardless of spring weather conditions. To minimize an effect of time within inventory period, we calculated a synthetic, capture-time-independent growth metrics called Body Mass Index (BMI), and test its variation over the inventory period and across years. For each bat capture event, BMI was calculated as the residuals from a linear regression of the logarithmically transformed weight (W) against the logarithm of the day-of-the-year (day).

Log-transformation scales BMI from -1 to 1, which facilitates its interpretation. Inspired by  [Mikryukov et al. 2023](https://www.science.org/doi/10.1126/sciadv.adj8016), and, partly, Scaled mass index - SMI by [Peig and Green 2009](https://nsojournals.onlinelibrary.wiley.com/doi/abs/10.1111/j.1600-0706.2009.17643.x)

```{r, echo=FALSE}
# Fit simple linear model (all years altogether)
mod <- lm(log(W) ~ log(day), data = df)

# Get residuals
df$BMI <- residuals(mod)

# Drop unused variables
rm(mod)
```

Check BMI's sensitivity to day-of-the-year:

```{r, echo=FALSE, warning=FALSE, message=FALSE}
p1 <- ggplot(data = df, aes(x = day, y = BMI)) +
  geom_point(shape = 1, alpha = 0.8) +
  geom_smooth(method = "lm", linewidth = .5) + 
  labs(title = "a) BMI for all data",
       x = "Day of the year",
       y = "Body Mass Index")

p2 <- ggplot(data = df, aes(x = day, y = BMI, colour = Year)) +
  geom_point(shape = 1, alpha = 0.8) +
  geom_smooth(method = "lm", aes(fill = Year), linewidth = .5) + 
  labs(title = "b) BMI per year",
       x = "Day of the year",
       y = "Body Mass Index") +
  theme(legend.position = c(.2, .22))

gridExtra::grid.arrange(p1, p2, nrow=1, ncol=2)
rm(p1, p2)
```

As we can see on the Figure above, BMI isn't sensitive to bat capture date within a survey period, but reflects differences among years.

```{r, echo=FALSE}
check_my_var(df, "BMI", "day", "Year")
```

Similarly, BMI shows no statistically significant dependency on capture date (day-of-the-year), even when we treat it for each year separately.

Therefore, three alternative response variables - forearm length (Ra), body weight at capture moment (W), and Body Mass Index (BMI), can be treated differently as a possible growth metric.


# Generate weather data
We downloaded daily weather data from ... using *easyclimate* package.

```{r eval=FALSE, echo=FALSE, message=FALSE}
# # Take a look at the timespan
# summary(df$date)

# # Create data frame with point coordinates
# coords <- read.csv("./data/coords.csv") %>%
#   # Make a new variable with places' unique identifiers
#   unite("place_id", Territory:place, remove = FALSE) %>%
#   select(-c(Territory, place))
# 
# # Retrieve daily weather values using {easyclimate} package
# # Prcp - Total precipitation in mm
# # Tmin - minimal temperature, Celsius degrees
# # Tmax - maximal temperature, Celsius degrees
# 
# daily <- get_daily_climate(
#   coords = coords,
#   period = 2007:2019,
#   climatic_var = c("Prcp","Tmin","Tmax"),
#   output = "df") %>%
#   mutate(Tmean = (Tmax + Tmin) / 2) %>%
#   select(-Tmax) %>%
#   mutate(date = as.Date(date))
# 
# save(daily, file = "./data/daily_weather_2007-2019.Rdata") # save weather data
```

```{r echo=FALSE}
load(file = "./data/daily_weather_2007-2019.Rdata")
daily <- daily %>% 
  mutate(date = as.Date(date)) %>% 
  # Aggregate climate data per territory/date
  separate(place_id, c("Territory", "placeCode")) %>% 
  select(-ID_coords, -placeCode) %>% 
  group_by(Territory, date) %>% 
  summarise(mean(Prcp), mean(Tmin), mean(Tmean)) %>% 
  rename(Prcp = 3, Tmin = 4, Tmean = 5)

df <- df %>% 
  rownames_to_column(var = "bat_id")
```

# Annual climate
As we saw both W and BMI have different intercepts across years, we can first check how years of survey varied by climatic variables.

```{r, echo=FALSE}
daily %>% 
  mutate(month = lubridate::month(date)) %>% 
  mutate(Year = as.factor(lubridate::year(date))) %>% 
  filter(month %in% c(4:6)) %>%
  filter(Territory %in% c("Homilsha") &
           Year %in% c(2008, 2011, 2014, 2019) |
           Territory == "Yaremivka" & 
           Year == 2009) %>% 
  ggplot(aes(x = Year, y = Tmean, colour = Territory)) +
  geom_boxplot() +
  labs(title = "Averaged Mean temperature for April-June",
       y = "Mean Temperature (°C)")
```

Mean daily temperature of April-June interval, averaged across each year, seems not to vary tremendously across years. If we try to desiccate it per month, the differences among years appear.

```{r, echo=FALSE}
daily %>% 
  mutate(month = lubridate::month(date)) %>% 
  mutate(Year = as.factor(lubridate::year(date))) %>% 
  filter(month %in% c(4:6)) %>%
  filter(Territory %in% c("Homilsha") &
           Year %in% c(2008, 2011, 2014, 2019) |
           Territory == "Yaremivka" & 
           Year == 2009) %>% 
  ggplot(aes(x = Year, y = Tmean, colour = Territory)) +
  geom_boxplot() +
  labs(title = "Averaged Mean temperature for April-June",
       y = "Mean Temperature (°C)") +
  facet_wrap(vars(month))
```


# Monthly climate
Here we explore the relationship among bat forearm length, weight, and Body Mass Index and simplest possible aggregated climatic variables - average mean temperature, average minimal temperature, and cumulative precipitation. Time period for aggregation - one calendar month.

```{r, echo=FALSE, warning=FALSE, message=FALSE}
daily %>% 
  mutate(month = lubridate::month(date)) %>% 
  mutate(Year = as.factor(lubridate::year(date))) %>% 
  # group_by(place_id, Year, month) %>% 
  group_by(Territory, Year, month) %>% 
  summarise(sum(Prcp), mean(Tmean), mean(Tmin)) %>% 
  rename(Prcp = 4, Tmean = 5, Tmin = 6) -> aggregated_clim

df %>% 
  # select(Territory, place_id, Year, Ra, W, BMI) %>% 
  select(Territory, place_id, Year, Ra, W, BMI) %>% 
  left_join(aggregated_clim) -> monthly_clim
rm(aggregated_clim)
```


Ra
```{r}
# Ra
monthly_clim %>% 
  filter(month %in% c(4:6)) %>%
  ggplot(aes(x = Tmean, y = Ra)) +
  geom_point(shape = 1) +
  # geom_smooth(method = "lm") +
  # geom_smooth() +
  stat_smooth(method = glm) +
  facet_wrap(vars(month), scales = "free") +
  labs(title = "Forearm length vs. Mean monthly temperature")

monthly_clim %>% 
  filter(month %in% c(4:6)) %>%
  ggplot(aes(x = Tmin, y = Ra)) +
  geom_point(shape = 1) +
  # geom_smooth(method = "lm") +
  # geom_smooth() +
  stat_smooth(method = glm) +
  facet_wrap(vars(month), scales = "free") +
  labs(title = "Forearm length vs. Minimal monthly temperature")

monthly_clim %>% 
  filter(month %in% c(4:6)) %>%
  ggplot(aes(x = Prcp, y = Ra)) +
  geom_point(shape = 1) +
  # geom_smooth(method = "lm") +
  # geom_smooth() +
  stat_smooth(method = glm) +
  facet_wrap(vars(month), scales = "free") +
  labs(title = "Forearm length vs. Cumulative monthly precipitation")
```

W
```{r}
# W
monthly_clim %>% 
  filter(month %in% c(4:6)) %>%
  ggplot(aes(x = Tmean, y = W)) +
  geom_point(shape = 1) +
  geom_smooth(method = "lm") +
  facet_wrap(vars(month), scales = "free") +
  labs(title = "Body weight vs. Mean monthly temperature")

monthly_clim %>% 
  filter(month %in% c(4:6)) %>%
  ggplot(aes(x = Tmin, y = W)) +
  geom_point(shape = 1) +
  geom_smooth(method = "lm") +
  facet_wrap(vars(month), scales = "free") +
  labs(title = "Body weight vs. Minimal monthly temperature")

monthly_clim %>% 
  filter(month %in% c(4:6)) %>%
  ggplot(aes(x = Prcp, y = W)) +
  geom_point(shape = 1) +
  geom_smooth(method = "lm") +
  facet_wrap(vars(month), scales = "free") +
  labs(title = "Body weight vs. Cumulative monthly precipitation")
```

BMI
```{r}
# BMI
monthly_clim %>% 
  filter(month %in% c(4:6)) %>%
  ggplot(aes(x = Tmean, y = BMI)) +
  geom_point(shape = 1) +
  geom_smooth(method = "lm") +
  facet_wrap(vars(month), scales = "free") +
  labs(title = "Body Mass Index vs. Mean monthly temperature")

monthly_clim %>% 
  filter(month %in% c(4:6)) %>%
  ggplot(aes(x = Tmin, y = BMI)) +
  geom_point(shape = 1) +
  geom_smooth(method = "lm") +
  facet_wrap(vars(month), scales = "free") +
  labs(title = "Body Mass Index vs. Minimal monthly temperature")

monthly_clim %>% 
  filter(month %in% c(4:6)) %>%
  ggplot(aes(x = Prcp, y = BMI)) +
  geom_point(shape = 1) +
  geom_smooth(method = "lm") +
  facet_wrap(vars(month), scales = "free") +
  labs(title = "Body Mass Index vs. Cumulative monthly precipitation")
```


## Climate differences across years
```{r}
monthly_clim %>% 
  filter(month %in% c(1:6)) %>%
  ggplot(aes(x = Tmean, y = BMI)) +
  geom_point(shape = 1) +
  geom_smooth(method = "lm") +
  facet_wrap(vars(month), scales = "free")
```


# Climwin

```{r, message=FALSE}
# Vignettes
# library(climwin)
# 
# vignette("climwin", package = "climwin")
# vignette("advanced_climwin", package = "climwin")

# Load necessary libraries
library(climwin)
library(lme4)

# Set priors

cdate <- daily$date  # date var in climate data
bdate <- df$date     # date var in biological data

# Relative or absolute time response.
# If "absolute", reference day as day, month is needed
type <- "absolute"
refday <- c(01, 07)

# If "relative", time window calculated for each individual value
# type <- "relative"
# refday <- NULL

# Temporal resolution of climate data
# cinterval <- "day"
cinterval <- "week"

# Upper and lower limit for tested climate windows respectively
# Must correspond to the resolution chosen in ‘cinterval’
# if 'cinterval' set to "days"
# range <- c(250, 0)

# if 'cinterval' set to "week"
# range <- c(30, 0) # (~ 1 Dec)
# range <- c(23, 0) # ~ 15 Jan
range <- c(13, 0) # ~ 1 Apr

stat <- "mean"

func <- "lin"

# number of repeats for randomization
# repeats <- 5 # for metric = "C"
repeats <- 200 # for metric = "AIC"

# Metrics for assessing
# metric = "C"
metric = "AIC"

# Number of years in data
sample.size = nlevels(as.factor(as.vector(df$Year)))
```

## Temperature
Here we explore two temperature predictors: Mean (Tmean) and Minimal (Tmin) daily temperatures, averaged across time window.

```{r}
# Set priors
# List of dependent variable candidates
xvar <- list(Tmean = daily$Tmean, Tmin = daily$Tmin)
```

### Ra
```{r}
# # Null model with no climate signal
baseline <- lm(Ra ~ 1, data = df)

# Null model with interaction
# Firstly, it is necessary to create a variable called ‘climate’ in the biological dataset.
# df$climate <- 1
# Set baseline model
# baseline <- lm(Ra ~ climate*sex, data = df)
```

Candidate model fitting
```{r, message=FALSE, warning=FALSE}
# Fit candidate model set
RaWin <- slidingwin(xvar = xvar,
                    cdate = daily$date,
                    bdate = df$date,
                    baseline = baseline,
                    cinterval = cinterval,
                    range = range,
                    type = type, refday = refday,
                    stat = stat,
                    func = func,
                    # spatial = list(df$place_id, daily$place_id)
                    spatial = list(df$Territory, daily$Territory)
                    )

save(RaWin, file = paste0(modeldir, "RaWin.Rdata"))
rm(RaWin)
gc()

# Fit randomized model set for evaluation purposes
RaRand <- randwin(repeats = repeats,
                  xvar = xvar,
                  cdate = cdate,
                  bdate = bdate,
                  baseline = baseline,
                  cinterval = cinterval,
                  range = range,
                  type = type, refday = refday,
                  stat = stat,
                  func = func,
                  # spatial = list(df$place_id, daily$place_id)
                  spatial = list(df$Territory, daily$Territory)
                  )

save(RaRand, file = paste0(modeldir, "RaRand.Rdata"))
rm(RaRand)
gc()
```

Model diagnostics
```{r}
load(file = paste0(modeldir, "RaWin.Rdata"))
# Possible combinations of model parameters
RaWin$combos
```

```{r}
candidate_models <- list()

for (i in 1:(length(RaWin)-1)) {
  candidate_models[[i]] <- head(RaWin[[i]]$Dataset)
}

candidate_models
```

```{r}
load(file = paste0(modeldir, "RaRand.Rdata"))
randomized_models <- list()

for (i in 1:(length(RaRand)-1)) {
  randomized_models[[i]] <- head(RaRand[[i]])
}

randomized_models
```

```{r}
# Plot residuals against fitted values to check dependency function
# (linear, quadratic, cubic, etc.)
p_res_fit <- list()

for (i in 1:(length(RaWin)-1)) {
  bestmod <- RaWin[[i]]$BestModel

  # Create residuals vs fitted plot
  p_res_fit[[i]] <- ggplot(bestmod, aes(x = .fitted, y = .resid)) +
    geom_point(alpha = 0.5) +
    geom_hline(yintercept = 0, linetype = 2) +
    geom_smooth() +
    labs(title = "Residuals vs. Fitted Plot for the best model candidate",
         x = "Fitted Values",
         y = "Residuals")
  
}

for (i in 1:length(p_res_fit)) {
  plot(p_res_fit[[i]])
}
```

```{r}
# Estimate how likely our observed result would be at random
# load(file = paste0(modeldir, "RaRand.Rdata"))

pvalues <- list()

for (i in 1:(length(RaRand)-1)) {
  pvalues[[i]] <- pvalue(dataset = RaWin[[i]]$Dataset,
                                   datasetrand = RaRand[[i]],
                                   metric = metric,
                                   sample.size = sample.size)
  
  print(pvalues[[i]])
}
```

```{r}
# Plot all diagnostic plots for a given parameter combination

plotalls <- list()

for (i in 1:(length(RaWin)-1)) {
  RaOutput <- RaWin[[i]]$Dataset
  RaRand_data <- RaRand[[i]]
  WindowOpen <- RaWin[[i]]$Dataset[1, 2]
  WindowClose <- RaWin[[i]]$Dataset[1, 3]
  
  
  # Fit single best model
  RaSingle <- singlewin(xvar = xvar[i],
                        cdate = cdate,
                        bdate = bdate,
                        baseline = baseline,
                        cinterval = cinterval,
                        range = c(WindowOpen, WindowClose),
                        type = type, refday = refday,
                        stat = stat,
                        func = func,
                        # spatial = list(df$place_id, daily$place_id)
                        spatial = list(df$Territory, daily$Territory))
  
  png(paste0(figuredir, "climwin_Ra_", RaWin$combos$climate[i], ".png"), width = 32 , height = 22, 
      units = "cm", res = 300)
  plotall(dataset = RaOutput,
          datasetrand = RaRand_data,
          bestmodel = RaSingle$BestModel,
          bestmodeldata = RaSingle$BestModelData)
  dev.off()
}
```


### Weight
```{r}
# Null model with no climate signal
baseline <- lm(W ~ 1, data = df)
```

Candidate model fitting
```{r, message=FALSE, warning=FALSE}
# Fit candidate model set
WWin <- slidingwin(xvar = xvar,
                    cdate = daily$date,
                    bdate = df$date,
                    baseline = baseline,
                    cinterval = cinterval,
                    range = range,
                    type = type, refday = refday,
                    stat = stat,
                    func = func,
                    spatial = list(df$place_id, daily$place_id))

save(WWin, file = paste0(modeldir, "WWin.Rdata"))
rm(WWin)
gc()

# Fit randomized model set for evaluation purposes
WRand <- randwin(repeats = repeats,
                  xvar = xvar,
                  cdate = cdate,
                  bdate = bdate,
                  baseline = baseline,
                  cinterval = cinterval,
                  range = range,
                  type = type, refday = refday,
                  stat = stat,
                  func = func,
                  spatial = list(df$place_id, daily$place_id))

save(WRand, file = paste0(modeldir, "WRand.Rdata"))
rm(WRand)
gc()
```

Model diagnostics
```{r}
load(file = paste0(modeldir, "WWin.Rdata"))
# Possible combinations of model parameters
WWin$combos
```

```{r}
candidate_models <- list()

for (i in 1:(length(WWin)-1)) {
  candidate_models[[i]] <- head(WWin[[i]]$Dataset)
}

candidate_models
```

```{r}
load(file = paste0(modeldir, "WRand.Rdata"))
randomized_models <- list()

for (i in 1:(length(WRand)-1)) {
  randomized_models[[i]] <- head(WRand[[i]])
}

randomized_models
```

```{r}
# Plot residuals against fitted values to check dependency function
# (linear, quadratic, cubic, etc.)
p_res_fit <- list()

for (i in 1:(length(WWin)-1)) {
  bestmod <- WWin[[i]]$BestModel

  # Create residuals vs fitted plot
  p_res_fit[[i]] <- ggplot(bestmod, aes(x = .fitted, y = .resid)) +
    geom_point(alpha = 0.5) +
    geom_hline(yintercept = 0, linetype = 2) +
    geom_smooth() +
    labs(title = "Residuals vs. Fitted Plot for the best model candidate",
         x = "Fitted Values",
         y = "Residuals")
  
}

for (i in 1:length(p_res_fit)) {
  plot(p_res_fit[[i]])
}
```

```{r}
# Estimate how likely our observed result would be at random
# load(file = paste0(modeldir, "WRand.Rdata"))

pvalues <- list()

for (i in 1:(length(WRand)-1)) {
  pvalues[[i]] <- pvalue(dataset = WWin[[i]]$Dataset,
                                   datasetrand = WRand[[i]],
                                   metric = metric,
                                   sample.size = sample.size)
  
  print(pvalues[[i]])
}
```

```{r}
# Plot all diagnostic plots for a given parameter combination
plotalls <- list()

for (i in 1:(length(WWin)-1)) {
  WOutput <- WWin[[i]]$Dataset
  WRand_data <- WRand[[i]]
  WindowOpen <- WWin[[i]]$Dataset[1, 2]
  WindowClose <- WWin[[i]]$Dataset[1, 3]
  
  
  # Fit single best model
  WSingle <- singlewin(xvar = xvar[i],
                        cdate = cdate,
                        bdate = bdate,
                        baseline = baseline,
                        cinterval = cinterval,
                        range = c(WindowOpen, WindowClose),
                        type = type, refday = refday,
                        stat = stat,
                        func = func,
                        spatial = list(df$place_id, daily$place_id))
  
  png(paste0(figuredir, "climwin_W_", WWin$combos$climate[i], ".png"), width = 32 , height = 22, 
      units = "cm", res = 300)
  plotall(dataset = WOutput,
          datasetrand = WRand_data,
          bestmodel = WSingle$BestModel,
          bestmodeldata = WSingle$BestModelData)
  dev.off()
}
```

### BMI
```{r}
# Null model with no climate signal
baseline <- lm(BMI ~ 1, data = df)
```

Candidate model fitting
```{r, message=FALSE, warning=FALSE}
# Fit candidate model set
# BMIWin <- slidingwin(xvar = xvar,
#                     cdate = daily$date,
#                     bdate = df$date,
#                     baseline = baseline,
#                     cinterval = cinterval,
#                     range = range,
#                     type = type, refday = refday,
#                     stat = stat,
#                     func = func,
#                     spatial = list(df$place_id, daily$place_id))
# 
# save(BMIWin, file = paste0(modeldir, "BMIWin.Rdata"))
# rm(BMIWin)
# gc()
# 
# # Fit randomized model set for evaluation purposes
# BMIRand <- randwin(repeats = repeats,
#                   xvar = xvar,
#                   cdate = cdate,
#                   bdate = bdate,
#                   baseline = baseline,
#                   cinterval = cinterval,
#                   range = range,
#                   type = type, refday = refday,
#                   stat = stat,
#                   func = func,
#                   spatial = list(df$place_id, daily$place_id))
# 
# save(BMIRand, file = paste0(modeldir, "BMIRand.Rdata"))
# rm(BMIRand)
# gc()
```

Model diagnostics
```{r}
load(file = paste0(modeldir, "BMIWin.Rdata"))
# Possible combinations of model parameters
BMIWin$combos
```

```{r}
candidate_models <- list()

for (i in 1:(length(BMIWin)-1)) {
  candidate_models[[i]] <- head(BMIWin[[i]]$Dataset)
}

candidate_models
```

```{r}
load(file = paste0(modeldir, "BMIRand.Rdata"))
randomized_models <- list()

for (i in 1:(length(BMIRand)-1)) {
  randomized_models[[i]] <- head(BMIRand[[i]])
}

randomized_models
```

```{r}
# Plot residuals against fitted values to check dependency function
# (linear, quadratic, cubic, etc.)
p_res_fit <- list()

for (i in 1:(length(BMIWin)-1)) {
  bestmod <- BMIWin[[i]]$BestModel

  # Create residuals vs fitted plot
  p_res_fit[[i]] <- ggplot(bestmod, aes(x = .fitted, y = .resid)) +
    geom_point(alpha = 0.5) +
    geom_hline(yintercept = 0, linetype = 2) +
    geom_smooth() +
    labs(title = "Residuals vs. Fitted Plot for the best model candidate",
         x = "Fitted Values",
         y = "Residuals")
  
}

for (i in 1:length(p_res_fit)) {
  plot(p_res_fit[[i]])
}
```

```{r}
# Estimate how likely our observed result would be at random
# load(file = paste0(modeldir, "BMIRand.Rdata"))

pvalues <- list()

for (i in 1:(length(BMIRand)-1)) {
  pvalues[[i]] <- pvalue(dataset = BMIWin[[i]]$Dataset,
                                   datasetrand = BMIRand[[i]],
                                   metric = metric,
                                   sample.size = sample.size)
  
  print(pvalues[[i]])
}
```

```{r}
# Plot all diagnostic plots for a given parameter combination
plotalls <- list()

for (i in 1:(length(BMIWin)-1)) {
  BMIOutput <- BMIWin[[i]]$Dataset
  BMIRand_data <- BMIRand[[i]]
  WindowOpen <- BMIWin[[i]]$Dataset[1, 2]
  WindowClose <- BMIWin[[i]]$Dataset[1, 3]
  
  
  # Fit single best model
  BMISingle <- singlewin(xvar = xvar[i],
                        cdate = cdate,
                        bdate = bdate,
                        baseline = baseline,
                        cinterval = cinterval,
                        range = c(WindowOpen, WindowClose),
                        type = type, refday = refday,
                        stat = stat,
                        func = func,
                        spatial = list(df$place_id, daily$place_id))
  
  png(paste0(figuredir, "climwin_BMI_", BMIWin$combos$climate[i], ".png"), width = 32 , height = 22, 
      units = "cm", res = 300)
  plotall(dataset = BMIOutput,
          datasetrand = BMIRand_data,
          bestmodel = BMISingle$BestModel,
          bestmodeldata = BMISingle$BestModelData)
  dev.off()
}
```

## Precipitation
Currently only average daily precipitation (Prcp) available.
```{r}
# Set priors
# List of dependent variable candidates
xvar <- list(Prcp = daily$Prcp)

stat <- "sum"
```

### Ra
```{r}
# Null model with no climate signal
baseline <- lm(Ra ~ 1, data = df)
```


Candidate model fitting
```{r, message=FALSE, warning=FALSE}
# # Fit candidate model set
# RaWin <- slidingwin(xvar = xvar,
#                     cdate = daily$date,
#                     bdate = df$date,
#                     baseline = baseline,
#                     cinterval = cinterval,
#                     range = range,
#                     type = type, refday = refday,
#                     stat = stat,
#                     func = func,
#                     spatial = list(df$place_id, daily$place_id))
# 
# save(RaWin, file = paste0(modeldir, "RaWin_Prcp.Rdata"))
# rm(RaWin)
# gc()
# 
# # Fit randomized model set for evaluation purposes
# RaRand <- randwin(repeats = repeats,
#                   xvar = xvar,
#                   cdate = cdate,
#                   bdate = bdate,
#                   baseline = baseline,
#                   cinterval = cinterval,
#                   range = range,
#                   type = type, refday = refday,
#                   stat = stat,
#                   func = func,
#                   spatial = list(df$place_id, daily$place_id))
# 
# save(RaRand, file = paste0(modeldir, "RaRand_Prcp.Rdata"))
# rm(RaRand)
# gc()
```

Model diagnostics
```{r}
load(file = paste0(modeldir, "RaWin_Prcp.Rdata"))
# Possible combinations of model parameters
RaWin$combos
```

```{r}
candidate_models <- list()

for (i in 1:(length(RaWin)-1)) {
  candidate_models[[i]] <- head(RaWin[[i]]$Dataset)
}

candidate_models
```


```{r}
load(file = paste0(modeldir, "RaRand_Prcp.Rdata"))
randomized_models <- list()

for (i in 1:(length(RaRand)-1)) {
  randomized_models[[i]] <- head(RaRand[[i]])
}

randomized_models
```


```{r}
# Plot residuals against fitted values to check dependency function
# (linear, quadratic, cubic, etc.)
p_res_fit <- list()

for (i in 1:(length(RaWin)-1)) {
  bestmod <- RaWin[[i]]$BestModel

  # Create residuals vs fitted plot
  p_res_fit[[i]] <- ggplot(bestmod, aes(x = .fitted, y = .resid)) +
    geom_point(alpha = 0.5) +
    geom_hline(yintercept = 0, linetype = 2) +
    geom_smooth() +
    labs(title = "Residuals vs. Fitted Plot for the best model candidate",
         x = "Fitted Values",
         y = "Residuals")
  
}

for (i in 1:length(p_res_fit)) {
  plot(p_res_fit[[i]])
}
```


```{r}
# Estimate how likely our observed result would be at random
# load(file = paste0(modeldir, "RaRand_Prcp.Rdata"))

pvalues <- list()

for (i in 1:(length(RaRand)-1)) {
  pvalues[[i]] <- pvalue(dataset = RaWin[[i]]$Dataset,
                                   datasetrand = RaRand[[i]],
                                   metric = metric,
                                   sample.size = sample.size)
  
  print(pvalues[[i]])
}
```

```{r}
# Plot all diagnostic plots for a given parameter combination

plotalls <- list()

for (i in 1:(length(RaWin)-1)) {
  RaOutput <- RaWin[[i]]$Dataset
  RaRand_data <- RaRand[[i]]
  WindowOpen <- RaWin[[i]]$Dataset[1, 2]
  WindowClose <- RaWin[[i]]$Dataset[1, 3]
  
  
  # Fit single best model
  RaSingle <- singlewin(xvar = xvar[i],
                        cdate = cdate,
                        bdate = bdate,
                        baseline = baseline,
                        cinterval = cinterval,
                        range = c(WindowOpen, WindowClose),
                        type = type, refday = refday,
                        stat = stat,
                        func = func,
                        spatial = list(df$place_id, daily$place_id))
  
  png(paste0(figuredir, "climwin_Ra_", RaWin$combos$climate[i], ".png"), width = 32 , height = 22, 
      units = "cm", res = 300)
  plotall(dataset = RaOutput,
          datasetrand = RaRand_data,
          bestmodel = RaSingle$BestModel,
          bestmodeldata = RaSingle$BestModelData)
  dev.off()
}
```


### W

```{r}
# Null model with no climate signal
baseline <- lm(W ~ 1, data = df)
```

Candidate model fitting
```{r, message=FALSE, warning=FALSE}
# # Fit candidate model set
# WWin <- slidingwin(xvar = xvar,
#                     cdate = daily$date,
#                     bdate = df$date,
#                     baseline = baseline,
#                     cinterval = cinterval,
#                     range = range,
#                     type = type, refday = refday,
#                     stat = stat,
#                     func = func,
#                     spatial = list(df$place_id, daily$place_id))
# 
# save(WWin, file = paste0(modeldir, "WWin_Prcp.Rdata"))
# rm(WWin)
# gc()
# 
# # Fit randomized model set for evaluation purposes
# WRand <- randwin(repeats = repeats,
#                   xvar = xvar,
#                   cdate = cdate,
#                   bdate = bdate,
#                   baseline = baseline,
#                   cinterval = cinterval,
#                   range = range,
#                   type = type, refday = refday,
#                   stat = stat,
#                   func = func,
#                   spatial = list(df$place_id, daily$place_id))
# 
# save(WRand, file = paste0(modeldir, "WRand_Prcp.Rdata"))
# rm(WRand)
# gc()
```

Model diagnostics
```{r}
load(file = paste0(modeldir, "WWin_Prcp.Rdata"))
# Possible combinations of model parameters
WWin$combos
```

```{r}
candidate_models <- list()

for (i in 1:(length(WWin)-1)) {
  candidate_models[[i]] <- head(WWin[[i]]$Dataset)
}

candidate_models
```

```{r}
load(file = paste0(modeldir, "WRand_Prcp.Rdata"))
randomized_models <- list()

for (i in 1:(length(WRand)-1)) {
  randomized_models[[i]] <- head(WRand[[i]])
}

randomized_models
```

```{r}
# Plot residuals against fitted values to check dependency function
# (linear, quadratic, cubic, etc.)
p_res_fit <- list()

for (i in 1:(length(WWin)-1)) {
  bestmod <- WWin[[i]]$BestModel

  # Create residuals vs fitted plot
  p_res_fit[[i]] <- ggplot(bestmod, aes(x = .fitted, y = .resid)) +
    geom_point(alpha = 0.5) +
    geom_hline(yintercept = 0, linetype = 2) +
    geom_smooth() +
    labs(title = "Residuals vs. Fitted Plot for the best model candidate",
         x = "Fitted Values",
         y = "Residuals")
  
}

for (i in 1:length(p_res_fit)) {
  plot(p_res_fit[[i]])
}
```

```{r}
# Estimate how likely our observed result would be at random
# load(file = paste0(modeldir, "WRand_Prcp.Rdata"))

pvalues <- list()

for (i in 1:(length(WRand)-1)) {
  pvalues[[i]] <- pvalue(dataset = WWin[[i]]$Dataset,
                                   datasetrand = WRand[[i]],
                                   metric = metric,
                                   sample.size = sample.size)
  
  print(pvalues[[i]])
}
```

```{r}
# Plot all diagnostic plots for a given parameter combination

plotalls <- list()

for (i in 1:(length(WWin)-1)) {
  WOutput <- WWin[[i]]$Dataset
  WRand_data <- WRand[[i]]
  WindowOpen <- WWin[[i]]$Dataset[1, 2]
  WindowClose <- WWin[[i]]$Dataset[1, 3]
  
  
  # Fit single best model
  WSingle <- singlewin(xvar = xvar[i],
                        cdate = cdate,
                        bdate = bdate,
                        baseline = baseline,
                        cinterval = cinterval,
                        range = c(WindowOpen, WindowClose),
                        type = type, refday = refday,
                        stat = stat,
                        func = func,
                        spatial = list(df$place_id, daily$place_id))
  
  png(paste0(figuredir, "climwin_W_", WWin$combos$climate[i], ".png"), width = 32 , height = 22, 
      units = "cm", res = 300)
  plotall(dataset = WOutput,
          datasetrand = WRand_data,
          bestmodel = WSingle$BestModel,
          bestmodeldata = WSingle$BestModelData)
  dev.off()
}
```

### BMI

```{r}
# Null model with no climate signal
baseline <- lm(BMI ~ 1, data = df)
```

Candidate model fitting
```{r, message=FALSE, warning=FALSE}
# # Fit candidate model set
# BMIWin <- slidingwin(xvar = xvar,
#                     cdate = daily$date,
#                     bdate = df$date,
#                     baseline = baseline,
#                     cinterval = cinterval,
#                     range = range,
#                     type = type, refday = refday,
#                     stat = stat,
#                     func = func,
#                     spatial = list(df$place_id, daily$place_id))
# 
# save(BMIWin, file = paste0(modeldir, "BMIWin_Prcp.Rdata"))
# rm(BMIWin)
# gc()
# 
# # Fit randomized model set for evaluation purposes
# BMIRand <- randwin(repeats = repeats,
#                   xvar = xvar,
#                   cdate = cdate,
#                   bdate = bdate,
#                   baseline = baseline,
#                   cinterval = cinterval,
#                   range = range,
#                   type = type, refday = refday,
#                   stat = stat,
#                   func = func,
#                   spatial = list(df$place_id, daily$place_id))
# 
# save(BMIRand, file = paste0(modeldir, "BMIRand_Prcp.Rdata"))
# rm(BMIRand)
# gc()
```

Model diagnostics
```{r}
load(file = paste0(modeldir, "BMIWin_Prcp.Rdata"))
# Possible combinations of model parameters
BMIWin$combos
```

```{r}
candidate_models <- list()

for (i in 1:(length(BMIWin)-1)) {
  candidate_models[[i]] <- head(BMIWin[[i]]$Dataset)
}

candidate_models
```

```{r}
load(file = paste0(modeldir, "BMIRand_Prcp.Rdata"))
randomized_models <- list()

for (i in 1:(length(BMIRand)-1)) {
  randomized_models[[i]] <- head(BMIRand[[i]])
}

randomized_models
```

```{r}
# Plot residuals against fitted values to check dependency function
# (linear, quadratic, cubic, etc.)
p_res_fit <- list()

for (i in 1:(length(BMIWin)-1)) {
  bestmod <- BMIWin[[i]]$BestModel

  # Create residuals vs fitted plot
  p_res_fit[[i]] <- ggplot(bestmod, aes(x = .fitted, y = .resid)) +
    geom_point(alpha = 0.5) +
    geom_hline(yintercept = 0, linetype = 2) +
    geom_smooth() +
    labs(title = "Residuals vs. Fitted Plot for the best model candidate",
         x = "Fitted Values",
         y = "Residuals")
  
}

for (i in 1:length(p_res_fit)) {
  plot(p_res_fit[[i]])
}
```

```{r}
# Estimate how likely our observed result would be at random
# load(file = paste0(modeldir, "BMIRand_Prcp.Rdata"))

pvalues <- list()

for (i in 1:(length(BMIRand)-1)) {
  pvalues[[i]] <- pvalue(dataset = BMIWin[[i]]$Dataset,
                                   datasetrand = BMIRand[[i]],
                                   metric = metric,
                                   sample.size = sample.size)
  
  print(pvalues[[i]])
}
```

```{r}
# Plot all diagnostic plots for a given parameter combination
plotalls <- list()

for (i in 1:(length(BMIWin)-1)) {
  BMIOutput <- BMIWin[[i]]$Dataset
  BMIRand_data <- BMIRand[[i]]
  WindowOpen <- BMIWin[[i]]$Dataset[1, 2]
  WindowClose <- BMIWin[[i]]$Dataset[1, 3]
  
  
  # Fit single best model
  BMISingle <- singlewin(xvar = xvar[i],
                        cdate = cdate,
                        bdate = bdate,
                        baseline = baseline,
                        cinterval = cinterval,
                        range = c(WindowOpen, WindowClose),
                        type = type, refday = refday,
                        stat = stat,
                        func = func,
                        spatial = list(df$place_id, daily$place_id))
  
  png(paste0(figuredir, "climwin_BMI_", BMIWin$combos$climate[i], ".png"), width = 32 , height = 22, 
      units = "cm", res = 300)
  plotall(dataset = BMIOutput,
          datasetrand = BMIRand_data,
          bestmodel = BMISingle$BestModel,
          bestmodeldata = BMISingle$BestModelData)
  dev.off()
}
```

# End of script